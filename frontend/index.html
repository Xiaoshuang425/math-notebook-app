<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KidAni AI - æ™ºèƒ½æ•¸å­¸å‹•ç•«è£½ç‰‡å» </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { font-family: 'Inter', 'PingFang TC', system-ui, sans-serif; }
        .main-bg { background-color: #f8fafc; }
        
        /* ä½ˆå±€éŸ¿æ‡‰å¼ */
        @media (min-width: 1024px) {
            .sidebar { width: 240px; background: white; border-right: 1px solid #e2e8f0; }
            .config-panel { width: 340px; background: white; border-right: 1px solid #e2e8f0; overflow-y: auto; }
            .main-content { overflow: hidden; height: 100vh; }
        }

        @media (max-width: 1023px) {
            .sidebar { display: none; }
            .config-panel { width: 100%; border-bottom: 1px solid #e2e8f0; height: auto; padding: 1rem; }
            .mobile-nav { display: flex; position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; z-index: 50; padding: 0.5rem 0; }
            .main-content { padding-bottom: 80px; overflow-y: auto; height: 100vh; }
        }

        /* å°è¦½æ¨£å¼ */
        .nav-item { cursor: pointer; display: flex; align-items: center; padding: 0.8rem 1.25rem; margin: 0.2rem 1rem; border-radius: 12px; font-size: 0.95rem; color: #64748b; transition: all 0.2s; }
        .nav-item.active { background: #3b82f6; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2); }
        .nav-item i { margin-right: 12px; width: 1.2rem; height: 1.2rem; }
        
        .m-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #94a3b8; cursor: pointer; }
        .m-nav-item.active { color: #3b82f6; font-weight: bold; }

        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: block; }
        
        .panel-content { display: none; }
        .panel-content.active { display: block; }
        
        /* æŒ‰éˆ•åˆ‡æ›æ¨£å¼ */
        .btn-toggle { transition: all 0.2s; border: 1px solid #e2e8f0; padding: 8px 12px; border-radius: 10px; font-size: 12px; font-weight: 600; background: #f8fafc; color: #64748b; width: 100%; text-align: center; }
        .btn-toggle.selected { background-color: #3b82f6 !important; color: white !important; border-color: #2563eb; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.2); }

        /* ä¸Šå‚³å€åŸŸ */
        .upload-zone { border: 2px dashed #e2e8f0; border-radius: 16px; padding: 1rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .upload-zone:hover { border-color: #3b82f6; background: #eff6ff; }

        /* å½±ç‰‡èˆ‡å¡ç‰‡ */
        .video-box { aspect-ratio: 16/9; background: #0f172a; position: relative; border: 4px solid white; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .card-flip { perspective: 1000px; height: 220px; cursor: pointer; margin: 0 auto; width: 100%; max-width: 340px; }
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card-flip.is-flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .card-front { background: white; color: #1e293b; }
        .card-back { background: #3b82f6; color: white; transform: rotateY(180deg); }
    </style>
</head>
<body class="main-bg h-screen flex flex-col lg:flex-row overflow-hidden">

    <!-- [é›»è…¦ç«¯] å·¦å°èˆª -->
    <nav class="sidebar hidden lg:flex flex-col py-6 shrink-0">
        <div class="px-8 mb-8 flex items-center text-blue-600 font-bold text-xl italic">
            <i data-lucide="zap" class="mr-2 fill-blue-600"></i> KidAni AI
        </div>
        <div data-target="video" class="nav-item active"><i data-lucide="clapperboard"></i> å‹•ç•«è£½ç‰‡</div>
        <div data-target="chat" class="nav-item"><i data-lucide="message-square"></i> æ™ºèƒ½å°å¸«</div>
        <div data-target="notes" class="nav-item"><i data-lucide="book-open"></i> å­¸éœ¸ç­†è¨˜</div>
        <div data-target="flashcards" class="nav-item"><i data-lucide="layers"></i> è¨˜æ†¶å¡ç‰‡</div>
    </nav>

    <!-- [æ‰‹æ©Ÿç«¯] åº•å°èˆª -->
    <div class="mobile-nav lg:hidden">
        <div data-target="video" class="m-nav-item active"><i data-lucide="clapperboard"></i><span>å½±ç‰‡</span></div>
        <div data-target="chat" class="m-nav-item"><i data-lucide="message-square"></i><span>å°å¸«</span></div>
        <div data-target="notes" class="m-nav-item"><i data-lucide="book-open"></i><span>ç­†è¨˜</span></div>
        <div data-target="flashcards" class="m-nav-item"><i data-lucide="layers"></i><span>å¡ç‰‡</span></div>
    </div>

    <!-- é…ç½®é¢æ¿ (é›»è…¦ç«¯ç¬¬äºŒæ¬„) -->
    <aside class="config-panel shrink-0 p-6 flex flex-col space-y-6">
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-slate-800">é…ç½®ä¸­å¿ƒ</h2>
            <div id="backend-status" class="w-3 h-3 rounded-full bg-gray-300"></div>
        </div>
        
        <!-- å‹•ç•«åˆ†é é…ç½® -->
        <div id="panel-video" class="panel-content active space-y-5">
            <div class="space-y-3">
                <h3 class="text-xs font-bold text-blue-600 flex items-center tracking-widest uppercase">
                    <i data-lucide="scan" class="w-3 h-3 mr-2"></i> 1. è¦–è¦ºè­˜åˆ¥ (Qwen-VL)
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <div class="upload-zone flex flex-col items-center justify-center p-4 bg-blue-50 border-blue-200" onclick="document.getElementById('file-input').click()">
                        <i data-lucide="camera" class="mb-1 text-blue-500 w-5 h-5"></i>
                        <span class="text-[10px] font-bold text-blue-600">æ‹ç…§è­˜åˆ¥</span>
                    </div>
                    <div class="upload-zone flex flex-col items-center justify-center p-4" onclick="document.getElementById('file-input').click()">
                        <i data-lucide="file-up" class="mb-1 text-slate-400 w-5 h-5"></i>
                        <span class="text-[10px] font-bold text-slate-500">ä¸Šå‚³èª²ä»¶</span>
                    </div>
                    <input type="file" id="file-input" class="hidden" accept="image/*" capture="environment">
                </div>
            </div>

            <div class="space-y-3 pt-2">
                <h3 class="text-xs font-bold text-blue-600 flex items-center tracking-widest uppercase">
                    <i data-lucide="sparkles" class="w-3 h-3 mr-2"></i> 2. ç”Ÿæˆè¨­å®š (Sora-2)
                </h3>
                <div class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400">æ•™å­¸ä¸»é¡Œ</label>
                        <input id="v-topic" type="text" class="w-full p-3 bg-slate-50 border rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="è­˜åˆ¥å¾Œè‡ªå‹•å¡«å…¥...">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400">ä¸»è¦è§’è‰²</label>
                        <select id="v-character" class="w-full p-3 bg-slate-50 border rounded-xl text-sm outline-none">
                            <option value="ç†Šå¤§ç†ŠäºŒ" selected>ç†Šå‡ºæ²’ (ç†Šå¤§ç†ŠäºŒ)</option>
                            <option value="å–œç¾Šç¾Š">å–œç¾Šç¾Šèˆ‡ç°å¤ªç‹¼</option>
                            <option value="è‰¾è">å†°é›ªå¥‡ç·£ (Elsa)</option>
                            <option value="å°åšå£«">å¡é€š AI åšå£«</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400">æ¸²æŸ“é¢¨æ ¼</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="btn-toggle selected">3D å‹•ç•«</button>
                            <button class="btn-toggle">2D ç¹ªæœ¬</button>
                        </div>
                    </div>
                </div>
            </div>

            <button id="v-gen" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-blue-700 transition-all flex items-center justify-center">
                <i data-lucide="wand-2" class="w-5 h-5 mr-2"></i> ç«‹å³è£½ä½œå‹•ç•«èª²ç¨‹
            </button>
        </div>

        <!-- å°å¸«åˆ†é é…ç½® -->
        <div id="panel-chat" class="panel-content space-y-5">
            <h3 class="text-xs font-bold text-blue-600 tracking-widest uppercase">å¤šæ¨¡æ…‹æ·±åº¦è§£æ</h3>
            <div class="upload-zone py-8" onclick="document.getElementById('chat-file-input').click()">
                <i data-lucide="image-plus" class="mx-auto mb-2 text-slate-300 w-8 h-8"></i>
                <p class="text-xs text-slate-400">æ‹ä¸‹ä½ ä¸æœƒåšçš„é¡Œç›®</p>
            </div>
            <input type="file" id="chat-file-input" class="hidden" accept="image/*">
            <div class="space-y-3">
                <label class="text-[10px] font-bold text-slate-400 italic">å°è©±åå¥½</label>
                <div class="grid grid-cols-1 gap-2">
                    <button class="btn-toggle selected">å¼•å°å¼æå• (ä¸ç›´æ¥çµ¦ç­”æ¡ˆ)</button>
                    <button class="btn-toggle">å¿«é€Ÿè§£ç­”æ¨¡å¼</button>
                </div>
            </div>
        </div>

        <!-- ç­†è¨˜åˆ†é é…ç½® -->
        <div id="panel-notes" class="panel-content space-y-5">
            <h3 class="text-xs font-bold text-blue-600 tracking-widest uppercase">ç­†è¨˜æ¨£å¼è‡ªå®šç¾©</h3>
            <div class="space-y-4">
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400">ç­†è¨˜é•·åº¦</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="btn-toggle selected">ç²¾ç°¡æ ¸å¿ƒ</button>
                        <button class="btn-toggle">è©³ç›¡åˆ†æ</button>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400">é‡é»æ¨™è¨»</label>
                    <div class="grid grid-cols-1 gap-2">
                        <button class="btn-toggle selected">è¢å…‰ç­†æ¨¡å¼</button>
                        <button class="btn-toggle">æ¢åˆ—æ¸…å–®æ¨¡å¼</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¡ç‰‡åˆ†é é…ç½® -->
        <div id="panel-flashcards" class="panel-content space-y-5">
            <h3 class="text-xs font-bold text-blue-600 tracking-widest uppercase">è¨˜æ†¶å¼·åŒ–æ¨¡å¼</h3>
            <div class="space-y-4">
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-400">è¤‡ç¿’æ¼”ç®—æ³•</label>
                    <div class="grid grid-cols-1 gap-2">
                        <button class="btn-toggle selected">è‰¾è³“æµ©æ–¯éºå¿˜æ›²ç·š</button>
                        <button class="btn-toggle">éš¨æ©ŸæŠ½å¡æ¨¡å¼</button>
                    </div>
                </div>
                <div class="p-4 bg-orange-50 rounded-xl border border-orange-100">
                    <p class="text-[10px] text-orange-600 font-bold leading-relaxed">
                        ğŸ’¡ ç³»çµ±æœƒæ ¹æ“š Qwen-VL è­˜åˆ¥å‡ºçš„é›£é»ï¼Œè‡ªå‹•ç‚ºä½ ç”Ÿæˆ 3-5 å¼µé—œéµè¨˜æ†¶å¡ç‰‡ã€‚
                    </p>
                </div>
            </div>
        </div>
    </aside>

    <!-- å³å´ä¸»è¦å…§å®¹ -->
    <main class="main-content flex-grow p-4 lg:p-8">
        
        <!-- Tab: å½±ç‰‡è£½ä½œ -->
        <div id="tab-video" class="tab-content active">
            <div class="flex flex-col space-y-4 lg:space-y-6">
                <div class="video-box rounded-2xl lg:rounded-[32px]">
                    <div id="v-main-display" class="w-full h-full flex items-center justify-center text-center p-4">
                        <div>
                            <h1 class="text-xl lg:text-3xl font-black text-white mb-2 tracking-widest">KIDANI AI STUDIO</h1>
                            <p class="text-blue-400 text-sm lg:text-lg font-bold">è®“ AI æˆç‚ºä½ çš„å°ˆå±¬å…§å®¹å‰µä½œè€…</p>
                        </div>
                    </div>
                    <div id="v-loader" class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center text-white z-10 px-6 text-center">
                        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent animate-spin rounded-full mb-4"></div>
                        <p id="v-status" class="font-bold text-sm lg:text-lg text-blue-400 italic">DeepSeek æ­£åœ¨è§£æå…§å®¹...</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-1 bg-white p-5 rounded-3xl border h-48 lg:h-64 overflow-y-auto shadow-sm">
                        <h3 class="font-bold mb-3 text-xs lg:text-sm flex items-center text-blue-600">
                            <i data-lucide="list-video" class="w-4 h-4 mr-2"></i> æ•™å­¸å¤§ç¶±
                        </h3>
                        <div id="v-playlist" class="space-y-2 text-xs text-slate-400 italic">æš«ç„¡æ’­æ”¾å…§å®¹</div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-5 rounded-3xl border shadow-sm">
                        <h3 class="font-bold mb-3 text-xs lg:text-sm flex items-center text-blue-600">
                            <i data-lucide="languages" class="w-4 h-4 mr-2"></i> è…³æœ¬å°ç™½ (Narration)
                        </h3>
                        <div id="v-narration" class="text-xs lg:text-sm text-slate-600 h-28 lg:h-40 overflow-y-auto leading-relaxed italic">ç­‰å¾…ç”Ÿæˆ...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: æ™ºèƒ½å°å¸« -->
        <div id="tab-chat" class="tab-content">
            <div class="flex flex-col h-full bg-white rounded-3xl border shadow-sm overflow-hidden">
                <div id="chat-box" class="flex-grow p-6 overflow-y-auto space-y-4">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xs">AI</div>
                        <div class="bg-slate-50 p-4 rounded-2xl rounded-tl-none text-sm text-slate-600 max-w-[85%] border">
                            ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI æ™ºèƒ½å°å¸«ã€‚ä½ å¯ä»¥é»æ“Šå·¦å´æ‹ç…§æŒ‰éˆ•ï¼Œè®“æˆ‘å¹«ä½ åˆ†æèª²æœ¬å…§å®¹ï¼
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 border-t flex gap-2">
                    <input id="chat-input" class="flex-grow p-3 bg-white rounded-xl text-sm border outline-none focus:ring-2 focus:ring-blue-500" placeholder="è©¢å•é—œæ–¼é¡Œç›®çš„ä»»ä½•å•é¡Œ...">
                    <button class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold text-sm shadow-md">å‚³é€</button>
                </div>
            </div>
        </div>

        <!-- Tab: å­¸éœ¸ç­†è¨˜ -->
        <div id="tab-notes" class="tab-content">
            <div class="max-w-3xl mx-auto space-y-6 h-full overflow-y-auto pb-10">
                <div class="bg-white p-8 lg:p-12 rounded-[32px] border shadow-sm min-h-full">
                    <div class="flex justify-between items-center mb-8 border-b pb-6">
                        <h2 class="text-2xl font-black text-slate-800">ğŸ“– AI çµæ§‹åŒ–ç­†è¨˜</h2>
                        <div class="flex gap-2">
                            <div class="w-3 h-3 rounded-full bg-red-400"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                            <div class="w-3 h-3 rounded-full bg-green-400"></div>
                        </div>
                    </div>
                    <div id="notes-content" class="text-slate-600 space-y-6">
                        <div class="flex flex-col items-center justify-center py-20 text-slate-300">
                            <i data-lucide="book-open-check" class="w-16 h-16 mb-4 opacity-20"></i>
                            <p class="text-sm font-medium italic">å°šæœªè­˜åˆ¥å…§å®¹ï¼Œè«‹å…ˆåœ¨ã€Œé…ç½®ä¸­å¿ƒã€æ‹ç…§è­˜åˆ¥</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: è¨˜æ†¶å¡ç‰‡ -->
        <div id="tab-flashcards" class="tab-content">
            <div class="flex flex-col items-center justify-center h-full space-y-10">
                <div id="flashcard" class="card-flip">
                    <div class="card-inner">
                        <div class="card-front">
                            <span class="text-[10px] font-bold text-blue-500 mb-4 tracking-widest uppercase">Question</span>
                            <p id="card-q" class="text-lg lg:text-xl font-black text-slate-700 text-center px-4 leading-relaxed">
                                æº–å‚™å¥½æŒ‘æˆ°äº†å—ï¼Ÿ
                            </p>
                            <div class="absolute bottom-6 flex items-center text-slate-400 text-[10px]">
                                <i data-lucide="mouse-pointer-2" class="w-3 h-3 mr-1"></i> é»æ“Šç¿»è½‰æŸ¥çœ‹ç­”æ¡ˆ
                            </div>
                        </div>
                        <div class="card-back">
                            <span class="text-[10px] font-bold text-white/70 mb-4 tracking-widest uppercase">Answer</span>
                            <p id="card-a" class="text-base lg:text-lg font-bold text-white text-center px-6 leading-relaxed">
                                ç­‰å¾…è¦–è¦ºè­˜åˆ¥å…§å®¹...
                            </p>
                        </div>
                    </div>
                </div>
                <div class="flex gap-4">
                    <button class="p-3 rounded-full bg-white border shadow-sm text-red-500 hover:bg-red-50 transition-colors"><i data-lucide="x"></i></button>
                    <button class="p-3 rounded-full bg-white border shadow-sm text-green-500 hover:bg-green-50 transition-colors"><i data-lucide="check"></i></button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = "http://localhost:8000";

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // 1. å…¨å±€åˆ†é èˆ‡é…ç½®åˆ‡æ›
            const switchTab = (target) => {
                document.querySelectorAll('.nav-item, .m-nav-item').forEach(el => {
                    el.classList.toggle('active', el.getAttribute('data-target') === target);
                });
                document.querySelectorAll('.panel-content, .tab-content').forEach(el => {
                    el.classList.toggle('active', el.id === `panel-${target}` || el.id === `tab-${target}`);
                });
            };

            document.querySelectorAll('.nav-item, .m-nav-item').forEach(nav => {
                nav.onclick = () => switchTab(nav.getAttribute('data-target'));
            });

            // 2. åˆ‡æ›æŒ‰éˆ• UI é‚è¼¯
            document.querySelectorAll('.btn-toggle').forEach(btn => {
                btn.onclick = function() {
                    const parent = this.parentElement;
                    parent.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                };
            });

            // 3. Qwen-VL è¦–è¦ºè­˜åˆ¥ä¸²æ¥
            const fileInput = document.getElementById('file-input');
            fileInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (re) => {
                    const base64Image = re.target.result;
                    showLoader("Qwen-VL æ­£åœ¨é€è¦–èª²æœ¬å…§å®¹...");
                    
                    try {
                        const res = await fetch(`${API_BASE}/analyze-image`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image_base64: base64Image })
                        });
                        const data = await res.json();
                        
                        // æ›´æ–° UI æ•¸æ“š
                        document.getElementById('v-topic').value = data.topic;
                        document.getElementById('notes-content').innerHTML = `
                            <div class="animate-in fade-in slide-in-from-bottom-4 duration-700">
                                <h4 class="text-blue-600 font-black text-lg mb-4 flex items-center">
                                    <i data-lucide="star" class="w-5 h-5 mr-2 fill-blue-600"></i> ${data.topic}
                                </h4>
                                <div class="space-y-4">
                                    ${data.notes.split('\n').map(note => `
                                        <div class="bg-blue-50/50 p-5 rounded-2xl border border-blue-100/50">
                                            <p class="text-sm lg:text-base font-medium">${note}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                        lucide.createIcons();
                        document.getElementById('card-q').innerText = data.flashcard_q;
                        document.getElementById('card-a').innerText = data.flashcard_a;
                        
                        // è‡ªå‹•å°èˆªè‡³ç­†è¨˜é 
                        if(window.innerWidth < 1024) switchTab('notes');
                        
                        hideLoader();
                    } catch (err) {
                        alert("å¾Œç«¯æ¥å£æœªå›æ‡‰ï¼Œè«‹æª¢æŸ¥ API æ˜¯å¦æ­£ç¢ºéƒ¨ç½²");
                        hideLoader();
                    }
                };
                reader.readAsDataURL(file);
            };

            // 4. å‹•ç•«ç”Ÿæˆæµç¨‹
            document.getElementById('v-gen').onclick = async () => {
                const topic = document.getElementById('v-topic').value;
                if(!topic) return alert("è«‹å…ˆè­˜åˆ¥é¡Œç›®æˆ–è¼¸å…¥ä¸»é¡Œ");

                showLoader("æ­£åœ¨ç·¨æ’ 3D å‹•ç•«åŠ‡æœ¬...");
                try {
                    const res = await fetch(`${API_BASE}/generate-video`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            topic: topic, 
                            character: document.getElementById('v-character').value 
                        })
                    });
                    const { task_id } = await res.json();
                    pollTask(task_id);
                } catch (e) {
                    alert("ç”Ÿæˆå¤±æ•—");
                    hideLoader();
                }
            };

            const pollTask = (taskId) => {
                const timer = setInterval(async () => {
                    try {
                        const res = await fetch(`${API_BASE}/task-status/${taskId}`);
                        const data = await res.json();
                        if(data.status === "processing") {
                            document.getElementById('v-status').innerText = data.message || "Sora æ­£åœ¨ç”Ÿæˆå½±ç‰‡...";
                        } else if(data.status === "completed") {
                            clearInterval(timer);
                            renderVideo(data.data);
                            hideLoader();
                        }
                    } catch (e) { clearInterval(timer); }
                }, 3000);
            };

            function showLoader(msg) {
                document.getElementById('v-loader').classList.remove('hidden');
                document.getElementById('v-status').innerText = msg;
            }
            function hideLoader() { document.getElementById('v-loader').classList.add('hidden'); }

            function renderVideo(courseData) {
                const list = document.getElementById('v-playlist');
                list.innerHTML = courseData.map((c, i) => `
                    <div class="p-3 bg-blue-50 rounded-xl border border-blue-100 cursor-pointer text-[11px] font-bold text-blue-600 hover:bg-blue-100" onclick="playScene(${i}, ${JSON.stringify(courseData).replace(/"/g, '&quot;')})">
                        ğŸ¬ ç¬¬ ${i+1} å¹•: ${c.title}
                    </div>
                `).join('');
                playScene(0, courseData);
            }

            window.playScene = (idx, data) => {
                document.getElementById('v-narration').innerText = data[idx].narration;
                document.getElementById('v-main-display').innerHTML = `
                    <video class="w-full h-full object-cover rounded-2xl" controls autoplay>
                        <source src="${data[idx].video_url}" type="video/mp4">
                    </video>`;
            };

            document.getElementById('flashcard').onclick = function() { this.classList.toggle('is-flipped'); };

            // å®šæ™‚å¥åº·æª¢æŸ¥
            setInterval(async () => {
                const dot = document.getElementById('backend-status');
                try {
                    const res = await fetch(`${API_BASE}/health`);
                    dot.style.backgroundColor = res.ok ? "#22c55e" : "#ef4444";
                } catch { dot.style.backgroundColor = "#ef4444"; }
            }, 5000);
        });
    </script>
</body>
</html>