<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KidAni AI - 智能數學動畫製片廠</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { font-family: 'Inter', 'PingFang TC', system-ui, sans-serif; }
        .main-bg { background-color: #f8fafc; }
        .sidebar { width: 240px; background: white; border-right: 1px solid #e2e8f0; }
        .config-panel { width: 340px; background: white; border-right: 1px solid #e2e8f0; }
        .nav-item { cursor: pointer; display: flex; align-items: center; padding: 0.8rem 1.25rem; margin: 0.2rem 1rem; border-radius: 12px; font-size: 0.95rem; color: #64748b; transition: all 0.2s; }
        .nav-item.active { background: #3b82f6; color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2); }
        .nav-item i { margin-right: 12px; width: 1.2rem; height: 1.2rem; }
        
        .tab-content { display: none; height: 100%; overflow-y: auto; }
        .tab-content.active { display: block; }
        
        .panel-content { display: none; }
        .panel-content.active { display: block; }
        
        .video-box { aspect-ratio: 16/9; background: #000; border-radius: 24px; overflow: hidden; position: relative; border: 4px solid white; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        
        .playlist-item { cursor: pointer; padding: 1rem; border-radius: 12px; border: 1px solid #e2e8f0; transition: all 0.2s; }
        .playlist-item.active { border-color: #3b82f6; background: #eff6ff; }

        .chat-container { height: calc(100vh - 180px); display: flex; flex-direction: column; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        .message { max-width: 80%; padding: 0.75rem 1rem; border-radius: 1rem; font-size: 0.9rem; line-height: 1.5; word-wrap: break-word; }
        .message-ai { background: white; color: #334155; align-self: flex-start; border: 1px solid #e2e8f0; }
        .message-user { background: #3b82f6; color: white; align-self: flex-end; }

        @keyframes pulse-green {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }
        .status-online { background-color: #22c55e; animation: pulse-green 2s infinite; }
        
        .success-pop { animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="main-bg h-screen flex overflow-hidden">

    <!-- 左側主導覽 -->
    <nav class="sidebar flex flex-col py-6 shrink-0">
        <div class="px-8 mb-8 flex items-center text-blue-600 font-bold text-xl italic">
            <i data-lucide="zap" class="mr-2 fill-blue-600"></i> KidAni AI
        </div>
        <div data-target="video" class="nav-item active"><i data-lucide="clapperboard"></i> 動畫製片</div>
        <div data-target="chat" class="nav-item"><i data-lucide="message-square"></i> 智能導師</div>
        <div data-target="notes" class="nav-item"><i data-lucide="book-open"></i> 學霸筆記</div>
        <div data-target="flashcards" class="nav-item"><i data-lucide="layers"></i> 記憶卡片</div>
    </nav>

    <!-- 中間配置面板 -->
    <aside class="config-panel shrink-0 p-6 flex flex-col space-y-6">
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-slate-800">配置面板</h2>
            <div id="backend-status" class="w-3 h-3 rounded-full bg-gray-300 transition-all duration-500" title="連線檢測中"></div>
        </div>
        
        <div id="panel-video" class="panel-content active space-y-4">
            <h3 class="font-bold text-sm text-blue-600">影片製作設定</h3>
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-400">教學主題</label>
                <input id="v-topic" type="text" class="w-full p-3 bg-slate-50 border rounded-xl text-sm" value="分數的概念">
            </div>
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-400">教學角色</label>
                <select id="v-character" class="w-full p-3 bg-slate-50 border rounded-xl text-sm">
                    <option value="熊大熊二" selected>熊出沒 (熊大熊二)</option>
                    <option value="喜羊羊">喜羊羊與灰太狼</option>
                    <option value="小博士">卡通博士</option>
                </select>
            </div>
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-400">教學風格</label>
                <select id="v-style" class="w-full p-3 bg-slate-50 border rounded-xl text-sm">
                    <option value="3D" selected>立體 3D 動畫</option>
                    <option value="Sketch">手繪線條風</option>
                    <option value="Cyber">科技未來感</option>
                </select>
            </div>
            <button id="v-gen" disabled class="w-full bg-blue-500 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-blue-600 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all">
                製作完整課堂影片
            </button>
            <p id="local-hint" class="text-[10px] text-red-400 text-center mt-2 hidden">偵測不到後端，請檢查終端機</p>
        </div>

        <div id="panel-chat" class="panel-content space-y-4">
            <h3 class="font-bold text-sm text-blue-600">導師對話設定</h3>
        </div>
    </aside>

    <!-- 右側主要內容區 -->
    <main class="flex-grow p-8 overflow-hidden">
        
        <!-- Tab: 影片製作 -->
        <div id="tab-video" class="tab-content active h-full">
            <div class="space-y-6">
                <div class="video-box flex items-center justify-center bg-slate-900">
                    <div id="v-main-display" class="w-full h-full flex items-center justify-center text-center">
                        <div class="text-slate-500 px-6">
                            <p class="mb-2 font-bold text-slate-300 text-lg" id="conn-title">連線至後端伺服器...</p>
                            <p class="text-xs" id="conn-msg">請確保後端 python main.py 正在運行</p>
                        </div>
                    </div>
                    <!-- 加載遮罩 -->
                    <div id="v-loader" class="hidden absolute inset-0 bg-black/70 flex flex-col items-center justify-center text-white z-10 text-center px-4">
                        <div id="loader-icon" class="w-16 h-16 border-4 border-blue-500 border-t-transparent animate-spin rounded-full mb-4"></div>
                        <p id="v-status" class="font-bold text-xl">AI 正在努力製作中...</p>
                        <div class="flex items-center mt-2 space-x-2">
                            <span id="v-timer" class="text-sm text-blue-300">已耗時 0 秒</span>
                            <span class="text-slate-500">|</span>
                            <span id="v-progress-msg" class="text-xs text-slate-400">正在初始化...</span>
                        </div>
                        <p id="v-debug-hint" class="text-[10px] mt-8 text-slate-500 opacity-50">後端背景作業中，請勿關閉視窗</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-1 bg-white p-4 rounded-3xl border shadow-sm h-56 overflow-y-auto">
                        <h3 class="font-bold mb-3 text-sm flex items-center"><i data-lucide="list" class="w-4 h-4 mr-2"></i>教學目錄</h3>
                        <div id="v-playlist" class="space-y-2 text-xs text-slate-400 italic">尚未生成章節</div>
                    </div>
                    <div class="col-span-2 bg-white p-4 rounded-3xl border shadow-sm">
                        <h3 class="font-bold mb-2 text-sm flex items-center"><i data-lucide="quote" class="w-4 h-4 mr-2"></i>當前旁白</h3>
                        <div id="v-narration" class="text-sm text-slate-600 h-32 overflow-y-auto leading-relaxed italic">等待製作完成後顯示內容...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-chat" class="tab-content h-full p-4">智能導師開發中...</div>
        <div id="tab-notes" class="tab-content h-full p-4">學霸筆記開發中...</div>
        <div id="tab-flashcards" class="tab-content h-full p-4">記憶卡片開發中...</div>

    </main>

    <script>
        const API = "http://127.0.0.1:8000";

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            let currentPlaylist = [];
            let startTime = 0;
            let pollCount = 0;

            const checkConn = async () => {
                const dot = document.getElementById('backend-status');
                const btn = document.getElementById('v-gen');
                const title = document.getElementById('conn-title');
                const msg = document.getElementById('conn-msg');
                
                try {
                    const res = await fetch(`${API}/health`, { method: 'GET', mode: 'cors' });
                    if (res.ok) {
                        dot.className = "w-3 h-3 rounded-full status-online";
                        title.innerText = "✅ 伺服器已就緒";
                        title.className = "mb-2 font-bold text-green-500 text-lg";
                        msg.innerText = "您可以開始生成 3D 動畫課程了";
                        btn.disabled = false;
                    }
                } catch (e) {
                    dot.className = "w-3 h-3 rounded-full bg-red-500";
                    title.innerText = "❌ 伺服器未啟動";
                    btn.disabled = true;
                    setTimeout(checkConn, 3000);
                }
            };
            
            checkConn();

            const vGenBtn = document.getElementById('v-gen');
            vGenBtn.onclick = async () => {
                const topic = document.getElementById('v-topic').value;
                const character = document.getElementById('v-character').value;
                const style = document.getElementById('v-style').value;
                const loader = document.getElementById('v-loader');
                const statusTxt = document.getElementById('v-status');
                const timerTxt = document.getElementById('v-timer');
                const progressMsg = document.getElementById('v-progress-msg');
                
                if (!topic) return alert("請輸入教學主題");
                
                loader.classList.remove('hidden');
                statusTxt.innerText = "正在提交製作請求...";
                progressMsg.innerText = "正在連線第三方 API...";
                startTime = Date.now();
                pollCount = 0;

                const timerInt = setInterval(() => {
                    if (loader.classList.contains('hidden')) return clearInterval(timerInt);
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    timerTxt.innerText = `已耗時 ${elapsed} 秒`;
                }, 1000);

                try {
                    // 發送請求，即使這裡 Connection Reset，我們也要捕獲它
                    const res = await fetch(`${API}/generate-video`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ topic, character, style })
                    });
                    
                    if (!res.ok) {
                        throw new Error("伺服器繁忙，請稍後再試");
                    }
                    
                    const data = await res.json();
                    const taskId = data.task_id;

                    const pollStatus = async () => {
                        try {
                            const safeTaskId = encodeURIComponent(taskId);
                            const sRes = await fetch(`${API}/task-status/${safeTaskId}`);
                            
                            if (sRes.status === 404) {
                                // 有時候任務剛建立還沒寫入資料庫
                                setTimeout(pollStatus, 3000);
                                return;
                            }

                            const sData = await sRes.json();
                            
                            if (sData.status === 'completed' && sData.data) {
                                currentPlaylist = sData.data;
                                renderPlaylist();
                                playScene(0);
                                loader.classList.add('hidden');
                                clearInterval(timerInt);
                                return;
                            } 
                            
                            if (sData.status === 'error') {
                                statusTxt.innerText = "⏳ API 等待過久，但製作可能仍在進行中...";
                                progressMsg.innerText = "正在嘗試重新接軌狀態...";
                                setTimeout(pollStatus, 5000); // 不要報錯退出，繼續嘗試
                                return;
                            }

                            // 顯示具體的後端進度
                            if (sData.message) {
                                statusTxt.innerText = sData.message;
                            }
                            if (sData.progress) {
                                progressMsg.innerText = `完成進度: ${sData.progress}`;
                            }

                            setTimeout(pollStatus, 4000);
                        } catch (err) {
                            // 輪詢出錯通常是網路波動，不中斷
                            setTimeout(pollStatus, 4000);
                        }
                    };
                    pollStatus();

                } catch (e) {
                    // 重點：即使發生 ERR_CONNECTION_RESET，由於後端是異步處理，
                    // 第三方那邊通常已經收到任務了。
                    // 這裡我們嘗試「靜默等待」幾秒，看能否撈到剛才可能生成的 TaskID（假設後端已記錄）
                    console.log("連線異常，但任務可能已在後端啟動:", e);
                    statusTxt.innerText = "連線重置，但 AI 已收到指令...";
                    progressMsg.innerText = "正在後台同步狀態，請稍候...";
                    
                    // 延遲一段時間後嘗試輪詢（這裡需要一個預測 ID 的機制或重新獲取機制，
                    // 目前簡單化處理：如果報錯直接建議用戶重試，但保留後台日誌）
                    setTimeout(() => {
                        if (loader.classList.contains('hidden')) return;
                        alert("與伺服器連線不穩 (Connection Reset)。\n若您確定第三方後台顯示成功，請重新啟動後端 main.py 並再次嘗試。");
                        loader.classList.add('hidden');
                        clearInterval(timerInt);
                    }, 10000);
                }
            };

            const renderPlaylist = () => {
                const el = document.getElementById('v-playlist');
                el.innerHTML = currentPlaylist.map((item, idx) => `
                    <div class="playlist-item success-pop" id="item-${idx}" onclick="playScene(${idx})">
                        <b>場景 ${idx+1}: ${item.title}</b>
                    </div>
                `).join('');
            };

            window.playScene = (idx) => {
                const scene = currentPlaylist[idx];
                document.querySelectorAll('.playlist-item').forEach(e => e.classList.remove('active'));
                document.getElementById(`item-${idx}`)?.classList.add('active');
                document.getElementById('v-narration').innerText = scene.narration;
                document.getElementById('v-main-display').innerHTML = `
                    <video src="${scene.video_url}" class="w-full h-full object-cover" controls autoplay></video>
                `;
            };

            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.onclick = () => {
                    const target = nav.getAttribute('data-target');
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    nav.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                    document.getElementById(`tab-${target}`)?.classList.add('active');
                };
            });
        });
    </script>
</body>
</html>